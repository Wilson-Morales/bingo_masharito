<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bingo Fundación Masharito</title>
    <!-- Carga de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Carga de Firebase (Auth y Firestore) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, updateDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Configuración de Firebase - Variables Globales (Disponibles en el entorno Canvas)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        // CORRECCIÓN: Se usa la variable global __initial_auth_token directamente aquí.
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // Inicialización de Firebase (Exportar como globales para uso en JS)
        window.firebaseApp = initializeApp(firebaseConfig);
        window.db = getFirestore(window.firebaseApp);
        window.auth = getAuth(window.firebaseApp);
        
        // Usar setLogLevel('Debug') para ver logs de Firestore si es necesario.
        // setLogLevel('Debug');

        /**
         * Inicializa la autenticación y establece el listener de estado.
         */
        window.setupFirebase = async () => {
            let userInitialized = false;
            
            // 1. Iniciar sesión: Usar token personalizado o anónimo
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(window.auth, initialAuthToken);
                } else {
                    await signInAnonymously(window.auth);
                }
            } catch (error) {
                console.error("Error during Firebase sign-in:", error);
            }

            // 2. Listener de estado de autenticación
            onAuthStateChanged(window.auth, (user) => {
                if (user && !userInitialized) {
                    window.userId = user.uid;
                    window.initFirestoreGameData(); // Cargar datos del juego
                    userInitialized = true;
                } else if (!user) {
                     // Caso donde la autenticación falla o se cierra sesión, usar ID anónimo temporal
                    window.userId = 'anon-' + crypto.randomUUID();
                    window.initFirestoreGameData(); 
                    userInitialized = true;
                }
            });
        };

        /**
         * Inicializa la escucha de Firestore y carga/guarda el estado del juego.
         */
        window.initFirestoreGameData = async () => {
            if (!window.db || !window.userId) {
                console.error("Firestore DB o userId no están disponibles.");
                return;
            }

            // Path: /artifacts/{appId}/users/{userId}/bingo_state/current_game
            const gameDocRef = doc(window.db, 
                `artifacts/${appId}/users/${window.userId}/bingo_state/current_game`
            );

            // Escuchar cambios en tiempo real
            onSnapshot(gameDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    console.log("Datos de Firestore cargados/actualizados:", data);
                    
                    // Solo actualizar si la aplicación no está girando activamente.
                    if (!window.isSpinning) {
                        const loadedAvailable = data.availableNumbers;
                        if (Array.isArray(loadedAvailable)) {
                            window.gameState.availableNumbers = loadedAvailable;
                        } else {
                            window.gameState.availableNumbers = Array.from({ length: 100 }, (_, i) => i + 1);
                        }
                        
                        window.gameState.drawnNumbers = data.drawnNumbers || [];
                        window.gameState.lastDrawnNumber = data.lastDrawnNumber || null;
                        
                        window.updateMatrixUI();
                        window.updateControlState();
                    }
                } else {
                    // Inicializar el documento si no existe
                    window.saveGameData();
                }
            }, (error) => {
                console.error("Error al escuchar Firestore:", error);
            });
        };

        /**
         * Guarda el estado actual del juego en Firestore.
         */
        window.saveGameData = async () => {
            if (!window.db || !window.userId) return;

            const gameDocRef = doc(window.db, 
                `artifacts/${appId}/users/${window.userId}/bingo_state/current_game`
            );

            const dataToSave = {
                availableNumbers: window.gameState.availableNumbers,
                drawnNumbers: window.gameState.drawnNumbers,
                lastDrawnNumber: window.gameState.lastDrawnNumber,
                timestamp: new Date().getTime()
            };

            try {
                await setDoc(gameDocRef, dataToSave, { merge: false });
                console.log("Estado del juego guardado en Firestore.");
            } catch (error) {
                console.error("Error al guardar en Firestore:", error);
            }
        };

        // Llama a la función de configuración de Firebase al cargar el script.
        window.setupFirebase();

    </script>
    <style>
        /* Estilos personalizados para el fondo y la matriz */
        .page-background {
            /* Fondo llamativo con gradiente de colores */
            background: linear-gradient(135deg, 
                #8e44ad, /* Morado */
                #c0392b, /* Rojo */
                #27ae60, /* Verde */
                #f1c40f, /* Amarillo */
                #3498db  /* Azul */
            );
            min-height: 100vh;
            font-family: 'Inter', sans-serif;
        }

        /* Estilo para la matriz de números */
        .number-matrix {
            border-collapse: collapse;
            width: 100%;
            max-width: 600px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        }

        .matrix-cell {
            height: 30px;
            width: 10%;
            text-align: center;
            font-weight: bold;
            color: black;
            border: 3px solid black; /* Bordes negros solid 3px */
            transition: background-color 0.3s ease;
            background-color: white; /* Color base blanco */
        }
        
        .marked {
            background-color: #fbd38d !important; /* Amarillo para celdas marcadas */
        }

        /* Estilos para el botón de acción */
        .action-button {
            padding: 12px 30px;
            font-size: 1.25rem;
            font-weight: bold;
            border-radius: 9999px; /* Botón burbuja */
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .action-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.2);
        }

        /* Estilo para el modal de resultado */
        .result-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 50;
        }

        .result-sphere {
            width: 200px;
            height: 200px;
            background-color: white;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 4rem;
            font-weight: 900;
            color: #333;
            box-shadow: 0 0 40px rgba(255, 255, 255, 0.8), 0 0 20px rgba(0, 0, 0, 0.5);
            animation: bounceIn 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55);
        }

        @keyframes bounceIn {
            0% { transform: scale(0); opacity: 0; }
            50% { transform: scale(1.2); opacity: 1; }
            100% { transform: scale(1); }
        }
        
        /* Estilo para el contenedor del GIF */
        #bingo-animation-container {
            width: 100%; /* Asegura que tome el ancho completo del padre en mobile */
            max-width: 400px; /* Limita el tamaño en desktop */
            aspect-ratio: 1 / 1; /* Hace que el contenedor sea siempre cuadrado */
            display: flex;
            justify-content: center;
            align-items: center;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 1rem;
            box-shadow: 0 0 50px rgba(0, 0, 0, 0.5);
            overflow: hidden; /* Oculta partes del GIF si es necesario */
        }
        
        /* El GIF de Tenor se renderizará dentro de #bingo-tenor-embed */
        /* Eliminamos los estilos de #bingo-gif */

        @media (min-width: 1024px) {
            #bingo-animation-container {
                width: 350px;
                height: 350px;
            }
        }
    </style>
</head>
<body class="page-background text-white p-4">

    <!-- Modal de Resultado (Inicialmente oculto) -->
    <div id="result-modal" class="result-modal-overlay hidden">
        <div class="result-sphere">
            <span id="drawn-number-display"></span>
        </div>
    </div>

    <div class="max-w-7xl mx-auto py-8">
        <h1 class="text-4xl md:text-5xl font-extrabold text-center mb-6 text-shadow-lg" style="text-shadow: 2px 2px #000;">
            Bingo Navideño
        </h1>

        <!-- Contenedor Principal: Animación de Bingo y Matriz -->
        <div class="flex flex-col lg:flex-row items-start justify-center gap-8">
            
            <!-- Columna de Animación y Controles -->
            <div class="w-full lg:w-1/3 flex flex-col items-center p-4 bg-white/10 rounded-xl shadow-2xl">
                

                <!-- Contenedor de la Animación GIF (Estructura corregida) -->
                <div id="bingo-animation-container" class="mb-8">
                    <!-- GIF de Bingo actualizado - Tenor Embed -->
                    <div id="bingo-tenor-embed" 
                         class="tenor-gif-embed" 
                         data-postid="10930740" 
                         data-share-method="host" 
                         data-aspect-ratio="1" 
                         data-width="100%"
                         style="display: none; height: 100%; width: 100%;">
                        <a href="https://tenor.com/view/bingo-gif-10930740">Bingo GIF</a>
                        from <a href="https://tenor.com/search/bingo-gifs">Bingo GIFs</a>
                    </div> 
                    <script type="text/javascript" async src="https://tenor.com/embed.js"></script>

                    <!-- Texto estático cuando no está girando -->
                    <div id="static-text" class="text-4xl font-bold text-white">¡A Jugar!</div>
                </div>


                <!-- Controles -->
                <div class="flex gap-4">
                    <button id="spin-button" onclick="spin()"
                        class="action-button bg-green-500 hover:bg-green-600 active:bg-green-700 text-white disabled:bg-gray-400">
                        Girar Ruleta
                    </button>
                    <button id="reset-button" onclick="resetGame()"
                        class="action-button bg-red-500 hover:bg-red-600 active:bg-red-700 text-white">
                        Resetear
                    </button>
                </div>
                <p class="mt-4 text-lg font-semibold text-yellow-400">
                    Siguiente Número: <span id="next-number-count">100</span> disponibles
                </p>
                <div id="message-box" class="mt-4 text-sm text-red-300"></div>

            </div>

            <!-- Columna de Matriz de Números -->
            <div class="w-full lg:w-2/3 flex justify-center p-4 bg-white/10 rounded-xl shadow-2xl">
                <table id="bingo-matrix" class="number-matrix">
                    <!-- Filas y Celdas generadas por JS -->
                </table>
            </div>

        </div>
    </div>

<script>
    // ===============================================
    // LÓGICA DEL JUEGO
    // ===============================================
    
    // Estado del juego (se cargará/guardará en Firestore)
    window.gameState = {
        availableNumbers: Array.from({ length: 100 }, (_, i) => i + 1), // [1, 2, ..., 100]
        drawnNumbers: [],
        lastDrawnNumber: null,
    };

    window.isSpinning = false; // Control de estado de animación
    const SPIN_DURATION_MS = 2000; // 5 segundos
    const RESULT_DISPLAY_DURATION_MS = 3000; // 5 segundos

    /** Inicializa la matriz de 10x10 en el DOM */
    function createMatrix() {
        const matrixTable = document.getElementById('bingo-matrix');
        let html = '';
        for (let i = 0; i < 10; i++) {
            html += '<tr>';
            for (let j = 0; j < 10; j++) {
                const number = i * 10 + j + 1;
                html += `<td id="cell-${number}" class="matrix-cell">${number}</td>`;
            }
            html += '</tr>';
        }
        matrixTable.innerHTML = html;
        window.updateMatrixUI(); // Aplicar el estado guardado si existe
    }

    /** Actualiza la UI de la matriz basándose en el estado de drawnNumbers */
    window.updateMatrixUI = () => {
        // Asegúrate de que el DOM esté listo antes de actualizar
        if (!document.getElementById('cell-1')) {
            createMatrix();
            return;
        }

        // Iterar sobre todos los números
        for (let num = 1; num <= 100; num++) {
            const cell = document.getElementById(`cell-${num}`);
            if (cell) {
                if (window.gameState.drawnNumbers.includes(num)) {
                    cell.classList.add('marked');
                } else {
                    cell.classList.remove('marked');
                }
            }
        }
        
        // Actualizar el contador de números disponibles
        document.getElementById('next-number-count').textContent = window.gameState.availableNumbers.length;
        
        // Actualizar el ID de usuario
        if(window.userId) {
            document.getElementById('user-id-display').textContent = window.userId;
        }

        // Actualizar el estado de los botones
        window.updateControlState();
    };

    /** Controla la disponibilidad del botón de girar */
    window.updateControlState = () => {
        const spinBtn = document.getElementById('spin-button');
        const resetBtn = document.getElementById('reset-button');
        
        const canSpin = !window.isSpinning && window.gameState.availableNumbers.length > 0;
        
        spinBtn.disabled = !canSpin;
        spinBtn.textContent = window.isSpinning ? 'Girando...' : (window.gameState.availableNumbers.length === 0 ? 'Juego Terminado' : 'Girar Ruleta');
        resetBtn.disabled = window.isSpinning;
        
        const messageBox = document.getElementById('message-box');
        if (window.gameState.availableNumbers.length === 0 && !window.isSpinning) {
            messageBox.textContent = "¡Todos los números han salido! Haz click en Resetear para jugar de nuevo.";
        } else {
            messageBox.textContent = "";
        }
    }


    /** Selecciona un número aleatorio de los disponibles */
    function drawRandomNumber() {
        if (window.gameState.availableNumbers.length === 0) {
            return null;
        }
        const randomIndex = Math.floor(Math.random() * window.gameState.availableNumbers.length);
        const drawnNumber = window.gameState.availableNumbers[randomIndex];

        // Mover de disponibles a extraídos
        window.gameState.availableNumbers.splice(randomIndex, 1);
        window.gameState.drawnNumbers.push(drawnNumber);
        window.gameState.lastDrawnNumber = drawnNumber;
        
        return drawnNumber;
    }

    /** Inicia el giro y selecciona el número (usando GIF) */
    window.spin = () => {
        if (window.isSpinning || window.gameState.availableNumbers.length === 0) {
            return;
        }

        window.isSpinning = true;
        window.updateControlState();
        
        // MODIFICACIÓN JS: Mostrar embed de Tenor, ocultar texto estático
        document.getElementById('bingo-tenor-embed').style.display = 'block';
        document.getElementById('static-text').style.display = 'none';

        // El número se selecciona al inicio del giro
        const drawnNumber = drawRandomNumber(); 
        
        // 2. Detener después de 5 segundos
        setTimeout(() => {
            window.stopSpin(drawnNumber);
        }, SPIN_DURATION_MS);
    };

    /** Detiene el giro, muestra el resultado y marca el número (usando GIF) */
    window.stopSpin = (drawnNumber) => {
        window.isSpinning = false;
        window.updateControlState();
        
        // MODIFICACIÓN JS: Ocultar embed de Tenor, mostrar texto estático
        document.getElementById('bingo-tenor-embed').style.display = 'none';
        document.getElementById('static-text').style.display = 'block';
        document.getElementById('static-text').textContent = "¡Número listo!"; // Mensaje de transición
        
        if (!drawnNumber) return;

        // 3. Mostrar el popup de resultado (5 segundos)
        const modal = document.getElementById('result-modal');
        const display = document.getElementById('drawn-number-display');
        
        display.textContent = drawnNumber;
        modal.classList.remove('hidden');

        // 4. Marcar en la matriz después de que el popup se oculte
        setTimeout(() => {
            modal.classList.add('hidden');
            window.markNumber(drawnNumber);
            window.saveGameData(); // Guardar el nuevo estado en Firestore
            document.getElementById('static-text').textContent = "¡A Jugar!"; // Restaurar mensaje inicial
        }, RESULT_DISPLAY_DURATION_MS);
    };

    /** Marca el número en la matriz */
    window.markNumber = (number) => {
        const cell = document.getElementById(`cell-${number}`);
        if (cell) {
            cell.classList.add('marked');
        }
        window.updateMatrixUI();
    };

    /** Reinicia el juego, borra las marcas y resetea el array de números */
    window.resetGame = () => {
        if (window.isSpinning) {
             console.log("No se puede resetear mientras está girando.");
             return;
        }
        
        // Resetear el estado global
        window.gameState.availableNumbers = Array.from({ length: 100 }, (_, i) => i + 1);
        window.gameState.drawnNumbers = [];
        window.gameState.lastDrawnNumber = null;
        
        // Borrar las marcas en la UI
        for (let num = 1; num <= 100; num++) {
            const cell = document.getElementById(`cell-${num}`);
            if (cell) {
                cell.classList.remove('marked');
            }
        }
        
        window.updateMatrixUI();
        window.saveGameData(); // Guardar estado de reseteo en Firestore
    };

    // ===============================================
    // Inicialización
    // ===============================================

    // Inicializa al cargar la ventana
    window.onload = function () {
        createMatrix(); // Inicializar la matriz
        window.updateControlState();
        
        // Muestra el ID de usuario una vez que esté disponible
        const userIdDisplay = document.getElementById('user-id-display');
        if(window.auth && window.auth.currentUser) {
             userIdDisplay.textContent = window.auth.currentUser.uid;
        } else {
             userIdDisplay.textContent = 'Anónimo';
        }
    }

</script>

</body>
</html>